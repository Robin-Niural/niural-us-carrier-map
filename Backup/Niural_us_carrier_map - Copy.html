<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Niural AI — US Carrier Map</title>

  <!-- D3 & TopoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --niural-purple:#714DFF;
      --niural-pink:#E151FF;
      --gradient: linear-gradient(135deg, var(--niural-purple) 0%, var(--niural-pink) 100%);

      --gray-950:#09090B;
      --gray-800:#27272A;
      --gray-600:#52525C;
      --gray-400:#A1A1AB;
      --ink:#FAFAFA;

      --kaiser:#60A5FA;
      --aetna:#6EE7B7;
      --restricted:#F59E0B;
      --unknown:#94A3B8;

      --bg: radial-gradient(1600px 800px at 10% -20%, rgba(113,77,255,0.15), transparent 55%),
            radial-gradient(1400px 900px at 110% 110%, rgba(225,81,255,0.12), transparent 60%),
            #0A0A0C;
      --panel:#0F0F13;
      --card:#13131A;
      --border:rgba(255,255,255,.10);
      --chip:#171724;
      --focus: rgba(113,77,255,0.65);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--ink);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      max-width: 1800px;
      margin: 0 auto;
      padding: clamp(16px,2vw,28px);
      display: grid;
      grid-template-columns: 1.25fr 0.75fr;
      gap: clamp(16px, 2vw, 24px);
    }

    header{
      grid-column: 1 / -1;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap: clamp(12px, 2vw, 20px);
      padding-bottom: clamp(10px, 1.2vw, 16px);
      border-bottom:1px solid var(--border);
    }
    .brand h1{margin:0 0 6px 0; font-weight:700; letter-spacing:.2px; font-size:clamp(22px, 2.2vw, 28px)}
    .brand p{margin:0; color:var(--gray-400); font-size:clamp(12px, 1.1vw, 14px)}

    .legendUI{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      background:var(--card); border:1px solid var(--border); padding:10px 12px; border-radius:14px;
    }
    .swatch{width:14px; height:14px; border-radius:4px; border:1px solid rgba(255,255,255,.2); display:inline-block; margin-right:6px}

    .mapWrap{
      background:var(--panel); border:1px solid var(--border); border-radius:18px; padding:clamp(12px,1.4vw,16px);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      min-height: 60vh;
    }
    .mapHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; gap:12px; flex-wrap:wrap;}
    .mapHeader h2{margin:0; font-size:clamp(16px,1.5vw,18px)}
    .controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .search{
      display:flex; gap:10px; align-items:center;
      background:var(--chip); border:1px solid var(--border); padding:6px 8px; border-radius:12px;
    }
    .search input{background:transparent; border:none; outline:none; color:var(--ink); font-size:14px; width:min(240px, 28vw);}
    .search:focus-within{box-shadow:0 0 0 3px var(--focus) inset}

    .filters{display:flex; gap:8px; align-items:center; background:var(--chip); border:1px solid var(--border); padding:6px 8px; border-radius:12px;}
    .filters label{display:flex; align-items:center; gap:6px; font-size:13px; color:var(--ink); cursor:pointer;}
    .filters input{accent-color: var(--niural-purple)}

    #map{ width:100%; height: min(78vh, 950px); display:block; border-radius:14px; background:#0b0f18; border:1px solid var(--border); }

    .side{ display:flex; flex-direction:column; gap:clamp(12px, 1.5vw, 16px); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:clamp(12px, 1.4vw, 18px); box-shadow: 0 12px 22px rgba(0,0,0,.24); }
    .card h3 {margin:0 0 8px 0; font-size:clamp(15px,1.4vw,16px)}
    .card p {margin:6px 0; color:var(--gray-400); line-height:1.55; font-size:14px}
    .kv{display:grid; grid-template-columns: minmax(120px, 200px) 1fr; gap:8px; font-size:14px;}
    .kv div:nth-child(odd){color:var(--gray-400)}
    .chip{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--border); font-size:12px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New"; font-size:12px; background:var(--panel); padding:2px 6px; border:1px solid var(--border); border-radius:6px}

    .tooltip{
      position:absolute; pointer-events:none; z-index:50; transform:translate(-50%,-120%);
      background:#0f1220; color:var(--ink); padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      box-shadow: 0 8px 24px rgba(0,0,0,.35); min-width:240px; opacity:0; transition: opacity .15s ease, transform .15s ease;
      font-size:13px; line-height:1.45;
    }
    .tooltip h4{margin:0 0 6px 0; font-size:14px}
    .tooltip .mini-kv{display:grid; grid-template-columns: 120px 1fr; gap:6px}
    .tooltip .dot{width:10px; height:10px; border-radius:99px; display:inline-block; vertical-align:middle; margin-right:6px; border:1px solid rgba(255,255,255,.2)}

    .state{transition:filter .15s ease, opacity .15s ease}
    .state:hover{filter:brightness(1.06)}
    .state.selected{stroke:#fff; stroke-width:1.6}
    .state.dim{opacity:.25}

    .abbr{
      font: 700 10px/1 Inter, system-ui, sans-serif;
      fill:#0f1115;
      paint-order: stroke;
      stroke: rgba(255,255,255,.9);
      stroke-width: 2px;
      text-anchor: middle;
      pointer-events:none;
    }
    .abbr tspan{ fill:#EEF1F6; stroke:none; }

    footer{ grid-column: 1 / -1; padding-top:10px; color:var(--gray-400); font-size:12px; display:flex; justify-content:space-between; align-items:center; }
    .cta{ background:var(--gradient); color:#fff; border:none; border-radius:10px; padding:10px 12px; font-weight:600; box-shadow: 0 10px 24px rgba(113,77,255,.25); cursor:pointer; }

    @media (max-width: 1100px){ .wrap{grid-template-columns: 1fr} #map{height: min(65vh, 760px)} }
    @media (max-width: 680px){ #map{height: 60vh} .kv{grid-template-columns: 1fr} }
    :focus-visible{outline:3px solid var(--focus); outline-offset:2px; border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>US Carrier Availability</h1>
        <p>Hover or click a state for carrier, large group definition, age-rating notes, and sales nuances.</p>
      </div>
      <div class="legendUI" aria-label="Map legend (UI-only)">
        <span><span class="swatch" style="background:var(--kaiser)"></span>Kaiser eligible</span>
        <span><span class="swatch" style="background:var(--aetna)"></span>Aetna</span>
        <span><span class="swatch" style="background:var(--restricted)"></span>Restricted / Licensing req.</span>
        <span><span class="swatch" style="background:var(--unknown)"></span>Unknown / Pending</span>
      </div>
    </header>

    <section class="mapWrap" aria-labelledby="map-title">
      <div class="mapHeader">
        <h2 id="map-title">Interactive Map</h2>
        <div class="controls">
          <div class="search">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="m21 21-4.3-4.3m1.8-5.2a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            </svg>
            <input id="stateSearch" placeholder="Search state (e.g., California)" aria-label="Search state"/>
          </div>
          <div class="filters" role="group" aria-label="Filter by carrier">
            <label><input type="checkbox" value="Kaiser" checked/> Kaiser</label>
            <label><input type="checkbox" value="Aetna" checked/> Aetna</label>
            <label><input type="checkbox" value="Restricted" checked/> Restricted</label>
            <label><input type="checkbox" value="Unknown" checked/> Unknown</label>
          </div>
          <button class="cta" onclick="downloadPNG()">Export map PNG</button>
        </div>
      </div>
      <svg id="map" role="img" aria-describedby="map-desc"></svg>
      <p id="map-desc" class="sr-only">Choropleth of US states by carrier categories with abbreviations and embedded legend for export.</p>
    </section>

    <aside class="side">
      <div class="card" id="detailCard">
        <h3 id="detailTitle">No state selected</h3>
        <div class="kv" id="detailBodyKV">
          <div>Primary carrier</div><div>—</div>
          <div>Large group definition</div><div>—</div>
          <div>Age group notes</div><div>—</div>
          <div>Sales nuances</div><div>—</div>
        </div>
      </div>

      <div class="card">
        <h3>Territories & Notes</h3>
        <div class="kv">
          <div>Puerto Rico</div>
          <div>HQ in PR may not offer an Aetna PEO medical master policy. Aetna can cover WSEs of continental US HQs with WSEs in PR. Only Indemnity / CMED plans available.</div>
          <div>US Virgin Islands</div>
          <div>Similar to PR: continental US HQs with WSEs in VI may be covered; Indemnity / CMED plans only.</div>
        </div>
      </div>

      <div class="card">
        <h3>How to edit data</h3>
        <p>Open this file and update the <span class="kbd">stateData</span> object (carrier, largeGroupDefinition, ageGroupNotes, salesNotes). Colors update automatically.</p>
      </div>
    </aside>

    <footer>
      <div>© Niural AI — Carrier visualization</div>
      <div>Keyboard: Tab to focus map, Enter to select.</div>
    </footer>
  </div>

  <div class="tooltip" id="tooltip" role="dialog" aria-hidden="true"></div>

  <script>
    // ---------- Data you can edit ----------
    const stateData = {
      // Kaiser
      "CA": { carrier: "Kaiser", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "Kaiser eligible." },
      "CO": { carrier: "Kaiser", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "Kaiser eligible." },
      "GA": { carrier: "Kaiser", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "Kaiser eligible." },
      "HI": { carrier: "Kaiser", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "Kaiser eligible." },
      "WA": { carrier: "Kaiser", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "Kaiser eligible." },

      // Restricted / licensing nuances
      "NM": { carrier: "Restricted", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "Restrictions and PEO licensing requirements apply." },
      "VT": { carrier: "Restricted", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "Restrictions and PEO licensing requirements apply." },

      // Example explicit Aetna override
      "DC": { carrier: "Aetna", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "" }
    };

    const svg = d3.select("#map");
    const width = svg.node().clientWidth;
    const height = svg.node().clientHeight;
    svg.attr("viewBox", `0 0 ${width} ${height}`);

    const projection = d3.geoAlbersUsa().translate([width/2, height/2]).scale(Math.min(width, height)*1.1);
    const path = d3.geoPath().projection(projection);

    const tooltip = d3.select("#tooltip");
    const detailTitle = d3.select("#detailTitle");
    const detailBodyKV = d3.select("#detailBodyKV");

    const colorForCarrier = (c) => {
      switch((c||"Unknown").toLowerCase()){
        case "kaiser": return getCSS("--kaiser");
        case "aetna": return getCSS("--aetna");
        case "restricted": return getCSS("--restricted");
        default: return getCSS("--unknown");
      }
    };
    function getCSS(varName){
      return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    }

    // FIPS -> USPS
    const fipsToUSPS = {
      1:"AL", 2:"AK", 4:"AZ", 5:"AR", 6:"CA", 8:"CO", 9:"CT", 10:"DE", 11:"DC", 12:"FL",
      13:"GA", 15:"HI", 16:"ID", 17:"IL", 18:"IN", 19:"IA", 20:"KS", 21:"KY", 22:"LA", 23:"ME",
      24:"MD", 25:"MA", 26:"MI", 27:"MN", 28:"MS", 29:"MO", 30:"MT", 31:"NE", 32:"NV", 33:"NH",
      34:"NJ", 35:"NM", 36:"NY", 37:"NC", 38:"ND", 39:"OH", 40:"OK", 41:"OR", 42:"PA", 44:"RI",
      45:"SC", 46:"SD", 47:"TN", 48:"TX", 49:"UT", 50:"VT", 51:"VA", 53:"WA", 54:"WV", 55:"WI", 56:"WY"
    };
    const nameToUSPS = {
      "Alabama":"AL","Alaska":"AK","Arizona":"AZ","Arkansas":"AR","California":"CA","Colorado":"CO","Connecticut":"CT","Delaware":"DE","District of Columbia":"DC","Florida":"FL","Georgia":"GA","Hawaii":"HI","Idaho":"ID","Illinois":"IL","Indiana":"IN","Iowa":"IA","Kansas":"KS","Kentucky":"KY","Louisiana":"LA","Maine":"ME","Maryland":"MD","Massachusetts":"MA","Michigan":"MI","Minnesota":"MN","Mississippi":"MS","Missouri":"MO","Montana":"MT","Nebraska":"NE","Nevada":"NV","New Hampshire":"NH","New Jersey":"NJ","New Mexico":"NM","New York":"NY","North Carolina":"NC","North Dakota":"ND","Ohio":"OH","Oklahoma":"OK","Oregon":"OR","Pennsylvania":"PA","Rhode Island":"RI","South Carolina":"SC","South Dakota":"SD","Tennessee":"TN","Texas":"TX","Utah":"UT","Vermont":"VT","Virginia":"VA","Washington":"WA","West Virginia":"WV","Wisconsin":"WI","Wyoming":"WY"
    };
    function uspsForFeature(d){
      return fipsToUSPS[d.id] || nameToUSPS[d.properties?.name] || "";
    }

    // Ensure every state has data (defaults to Aetna)
    Object.values(fipsToUSPS).forEach(code => {
      if (!stateData[code]) stateData[code] = { carrier: "Aetna", largeGroupDefinition: "TBD", ageGroupNotes: "TBD", salesNotes: "" };
    });

    const topoUrl = "https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json";
    d3.json(topoUrl).then(us => {
      const states = topojson.feature(us, us.objects.states);
      const statesMesh = topojson.mesh(us, us.objects.states, (a, b) => a !== b);

      // Root group for map content
      const g = svg.append("g").attr("id","gRoot");

      // States
      const statePaths = g.selectAll("path.state")
        .data(states.features)
        .join("path")
        .attr("class", "state")
        .attr("d", path)
        .attr("fill", d => colorForCarrier(stateData[uspsForFeature(d)]?.carrier))
        .attr("stroke", "rgba(255,255,255,.16)")
        .attr("stroke-width", 0.8)
        .on("mousemove", (event, d) => {
          const code = uspsForFeature(d);
          const name = d.properties.name;
          const info = stateData[code] || {};
          showTooltip(event.pageX, event.pageY, name, code, info);
        })
        .on("mouseleave", hideTooltip)
        .on("click", (event, d) => {
          statePaths.classed("selected", false);
          d3.select(event.currentTarget).classed("selected", true);
          const code = uspsForFeature(d);
          const name = d.properties.name;
          const info = stateData[code] || {};
          renderDetail(name, code, info);
        })
        .attr("tabindex", 0)
        .on("keydown", (event, d) => {
          if (event.key === "Enter"){
            const node = event.currentTarget;
            statePaths.classed("selected", false);
            d3.select(node).classed("selected", true);
            const code = uspsForFeature(d);
            const name = d.properties.name;
            const info = stateData[code] || {};
            renderDetail(name, code, info);
          }
        });

      // Labels (state abbreviations)
      const labels = g.selectAll("text.abbr")
        .data(states.features)
        .join("text")
        .attr("class","abbr")
        .attr("transform", d => `translate(${path.centroid(d)})`)
        .html(d => `<tspan>${uspsForFeature(d)}</tspan>`);

      // Manual offsets for tiny/overlapping states
      const offsets = {"RI":[12,-2],"CT":[12,2],"MA":[18,-8],"NJ":[10,6],"DE":[14,8],"MD":[20,12],"DC":[-6,8]};
      labels.attr("transform", d => {
        const c = path.centroid(d);
        const code = uspsForFeature(d);
        const off = offsets[code];
        return off ? `translate(${c[0]+off[0]},${c[1]+off[1]})` : `translate(${c[0]},${c[1]})`;
      });

      // Borders overlay
      g.append("path")
        .datum(statesMesh)
        .attr("fill", "none")
        .attr("stroke", "rgba(255,255,255,.33)")
        .attr("stroke-width", 0.6)
        .attr("d", path);

      // Search (by name or abbreviation)
      const search = document.getElementById("stateSearch");
      search.addEventListener("input", (e)=>{
        const q = e.target.value.trim().toLowerCase();
        if(!q){ statePaths.classed("selected", false); return; }
        const match = states.features.find(f =>
          f.properties.name.toLowerCase().startsWith(q) ||
          uspsForFeature(f).toLowerCase().startsWith(q)
        );
        if (match){
          const node = statePaths.filter(d => d === match).node();
          if (node){
            statePaths.classed("selected", false);
            node.classList.add("selected");
            const code = uspsForFeature(match);
            renderDetail(match.properties.name, code, stateData[code] || {});
            const [[x0,y0],[x1,y1]] = path.bounds(match);
            const s = Math.min(5, .85 / Math.max((x1-x0)/width,(y1-y0)/height));
            const tx = width/2 - s*(x0+x1)/2;
            const ty = height/2 - s*(y0+y1)/2;
            g.transition().duration(550).attr("transform", `translate(${tx},${ty}) scale(${s})`);
          }
        }
      });

      // Filters
      const filterInputs = Array.from(document.querySelectorAll(".filters input"));
      function applyFilters(){
        const active = new Set(filterInputs.filter(i => i.checked).map(i => i.value.toLowerCase()));
        statePaths.classed("dim", d => {
          const code = uspsForFeature(d);
          const c = (stateData[code]?.carrier || "Unknown").toLowerCase();
          return !active.has(c);
        });
        labels.each(function(d){
          const code = uspsForFeature(d);
          const c = (stateData[code]?.carrier || "Unknown").toLowerCase();
          d3.select(this).attr("opacity", active.has(c) ? 1 : 0.25);
        });
      }
      filterInputs.forEach(inp => inp.addEventListener("change", applyFilters));
      applyFilters();

      // Responsive, non-overlapping embedded SVG legend (exports with PNG)
      let legend;
      function renderLegend() {
        if (legend) legend.remove();
        legend = svg.append("g").attr("id", "svgLegend");

        // Actual drawn map area
        const mapBBox = d3.select("#gRoot").node().getBBox();
        const innerX = mapBBox.x, innerY = mapBBox.y, innerW = mapBBox.width, innerH = mapBBox.height;

        // Scale for laptop screens
        const scale = Math.max(0.72, Math.min(1, width / 1280));
        const PAD = 16 * scale;
        const ITEM_H = 20 * scale;
        const SW = 12 * scale;
        const RADIUS = 10 * scale;
        const FONT = 12 * scale;
        const BOX_W = Math.min(260, Math.max(220, width * 0.22));

        // Estimate height to choose top/bottom placement
        const boxEstimate = (4 * ITEM_H) + PAD * 2 + 32 * scale;
        const preferTop = (innerY + boxEstimate + 24) < (height * 0.45);
        const legendX = innerX + 12;
        const legendY = preferTop ? (innerY + 12) : (innerY + innerH - boxEstimate - 12);

        // Background (resized later)
        const bg = legend.append("rect")
          .attr("x", legendX).attr("y", legendY)
          .attr("rx", RADIUS).attr("ry", RADIUS)
          .attr("width", BOX_W)
          .attr("fill", "rgba(19,19,26,0.92)")
          .attr("stroke", "rgba(255,255,255,.12)");

        // Title
        const titleEl = legend.append("text")
          .attr("x", legendX + PAD)
          .attr("y", legendY + PAD)
          .attr("fill", "#EDEDEF")
          .attr("font-size", `${FONT}px`)
          .attr("font-weight", "700")
          .attr("dominant-baseline", "hanging")
          .text("Legend");

        // Title height -> safe start for items
        const titleBox = titleEl.node().getBBox();
        let yCursor = titleBox.y + titleBox.height + (8 * scale);

        const items = [
          { label: "Kaiser eligible",              color: getCSS("--kaiser") },
          { label: "Aetna",                         color: getCSS("--aetna") },
          { label: "Restricted / Licensing req.",   color: getCSS("--restricted") },
          { label: "Unknown / Pending",             color: getCSS("--unknown") },
        ];

        // Items
        items.forEach(it => {
          legend.append("rect")
            .attr("x", legendX + PAD)
            .attr("y", yCursor)
            .attr("width", SW).attr("height", SW).attr("rx", 3 * scale)
            .attr("fill", it.color).attr("stroke", "rgba(255,255,255,.2)");

          legend.append("text")
            .attr("x", legendX + PAD + SW + 6 * scale)
            .attr("y", yCursor)
            .attr("fill", "#EDEDEF")
            .attr("font-size", `${FONT}px`)
            .attr("dominant-baseline", "hanging")
            .text(it.label);

          yCursor += ITEM_H;
        });

        // Resize background to content
        const boxH = (yCursor - legendY) + PAD;
        bg.attr("height", boxH);
      }

      // Initial legend render + reposition on resize
      renderLegend();
      function onResize() {
        const w = svg.node().clientWidth;
        const h = svg.node().clientHeight;
        svg.attr("viewBox", `0 0 ${w} ${h}`);
        renderLegend();
      }
      window.addEventListener("resize", onResize);

      // Tooltip & details
      function showTooltip(x, y, name, code, info){
        tooltip.html(`
          <h4>${name} <span style="opacity:.75;font-weight:500;">(${code})</span></h4>
          <div class="mini-kv">
            <div>Carrier</div><div><span class="dot" style="background:${colorForCarrier(info.carrier)}"></span>${info.carrier||"Unknown"}</div>
            <div>Large Group</div><div>${info.largeGroupDefinition||"TBD"}</div>
            <div>Age Group</div><div>${info.ageGroupNotes||"TBD"}</div>
          </div>
          ${info.salesNotes ? `<div style="margin-top:6px; color:var(--gray-400)">${info.salesNotes}</div>` : ""}
        `);
        tooltip.style("left", x + "px").style("top", y + "px").style("opacity", 1).attr("aria-hidden", "false").style("transform","translate(-50%,-120%)");
      }
      function hideTooltip(){ tooltip.style("opacity", 0).attr("aria-hidden","true"); }
      function renderDetail(name, code, info){
        detailTitle.text(`${name} (${code})`);
        detailBodyKV.html("");
        const rows = [
          ["Primary carrier", info.carrier || "Unknown"],
          ["Large group definition", info.largeGroupDefinition || "TBD"],
          ["Age group notes", info.ageGroupNotes || "TBD"],
          ["Sales nuances", info.salesNotes || "—"],
        ];
        rows.forEach(([k,v]) => {
          detailBodyKV.append("div").text(k);
          if (k === "Primary carrier"){
            detailBodyKV.append("div").html(`<span class="chip"><span style="width:8px;height:8px;border-radius:99px;background:${colorForCarrier(info.carrier)};display:inline-block"></span>${v}</span>`);
          } else {
            detailBodyKV.append("div").text(v);
          }
        });
      }

      // Reset selection by clicking outside
      document.body.addEventListener("click", (e)=>{
        const mapEl = document.getElementById("map");
        if (!mapEl.contains(e.target)){
          statePaths.classed("selected", false);
          g.transition().duration(400).attr("transform", `translate(0,0) scale(1)`);
          detailTitle.text("No state selected");
          detailBodyKV.html(`
            <div>Primary carrier</div><div>—</div>
            <div>Large group definition</div><div>—</div>
            <div>Age group notes</div><div>—</div>
            <div>Sales nuances</div><div>—</div>`);
        }
      }, true);
    }).catch(err => {
      console.error("Failed to load US TopoJSON:", err);
      const fallback = document.createElement("div");
      fallback.style.color = "#fca5a5";
      fallback.style.padding = "12px";
      fallback.textContent = "Failed to load map data. Please check your internet connection or try again.";
      document.querySelector(".mapWrap").appendChild(fallback);
    });

    // Export map (SVG -> PNG) including embedded legend and labels
    function downloadPNG(){
      const svgEl = document.getElementById("map");
      const serializer = new XMLSerializer();
      const svgString = serializer.serializeToString(svgEl);
      const bbox = svgEl.getBoundingClientRect();
      const pixelRatio = Math.max(2, window.devicePixelRatio || 1); // upscale for clarity

      const canvas = document.createElement("canvas");
      canvas.width = bbox.width * pixelRatio;
      canvas.height = bbox.height * pixelRatio;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#0b0f18";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      const img = new Image();
      img.onload = () => {
        ctx.setTransform(pixelRatio, 0, 0, pixelRatio, 0, 0);
        ctx.drawImage(img, 0, 0, bbox.width, bbox.height);
        const a = document.createElement("a");
        a.download = "niural_us_carrier_map.png";
        a.href = canvas.toDataURL("image/png");
        a.click();
      };
      img.src = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgString)));
    }
  </script>
</body>
</html>
